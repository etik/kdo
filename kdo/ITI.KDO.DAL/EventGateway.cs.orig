using Dapper;
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using System.Text;

namespace ITI.KDO.DAL
{
    public class EventGateway
    {
        readonly string _connectionString;

        public EventGateway(string connectionString)
        {
            _connectionString = connectionString;
        }

        ///<summary>
        ///Find Event of User with UserId
        ///</summary>
        ///<param name="userId"></param>
        ///<returns></return>
        public Event FindById(int eventId)
        {
            using (SqlConnection con = new SqlConnection(_connectionString))
            {
                return con.Query<Event>(
                    @"select e.UserId,
                             e.EventId,
                             e.EventName,
                             e.Descriptions,
                             e.Dates
                          from dbo.vEvent e
                          where e.EventId = @EventId",
                          new { EventId = eventId })
                          .FirstOrDefault(); 
            }
        }

        /// <summary>
        /// Add Event to User and return the EventId
        /// </summary>
        /// <param name="eventName"></param>
        /// <param name="description"></param>
        /// <param name="dates"></param>
        /// <param name="userId"></param>
<<<<<<< HEAD
        public int Create(string eventName, string descriptions, DateTime dates, int userId)
=======
        public int Create(string eventName, string description, DateTime dates, int userId)
>>>>>>> EventsCreation
        {
            using (SqlConnection con = new SqlConnection(_connectionString))
            {
                var dynamicParameters = new DynamicParameters();
                dynamicParameters.Add("@EventName", eventName, DbType.String);
<<<<<<< HEAD
                dynamicParameters.Add("@Descriptions", descriptions, DbType.String);
=======
                dynamicParameters.Add("@Descriptions", description, DbType.String);
>>>>>>> EventsCreation
                dynamicParameters.Add("@Dates", dates, DbType.DateTime2);
                dynamicParameters.Add("@UserId", userId, DbType.Int32);
                dynamicParameters.Add("@Id", DbType.Int32, direction: ParameterDirection.ReturnValue);

                con.Execute(
                    "dbo.sEventCreate",
                    dynamicParameters,
                    commandType: CommandType.StoredProcedure
                );
                return dynamicParameters.Get<int>("@Id");
            }
        }

        /// <summary>
        /// Update Event Of User
        /// </summary>
        /// <param name="eventName"></param>
        /// <param name="descriptions"></param>
        /// <param name="dates"></param>
        /// <param name="userId"></param>
        public void Update(int eventId, string eventName, string descriptions,DateTime dates)
        {
            using (SqlConnection con = new SqlConnection(_connectionString))
            {
                con.Execute(
               "dbo.sEventUpdate",
               new
               {
                   EventId = eventId,
                   EventName = eventName,
                   Descriptions = descriptions,
                   Dates = dates
               },
               commandType: CommandType.StoredProcedure);
            }
        }

        /// <summary>
        /// Delete Event Of User
        /// </summary>
        /// <param name="eventId"></param>
        /// <param name="userId"></param>
        public void Delete(int eventId)
        {
            using (SqlConnection con = new SqlConnection(_connectionString))
            {
                con.Execute(
                    "dbo.sEventDelete",
                    new { EventId = eventId },
                    commandType: CommandType.StoredProcedure);
            }
        }
        /// <summary>
        /// Get ALL Event by the UserId
        /// </summary>
        /// <param name="userId"></param>
        /// <returns></returns>
        public IEnumerable<Event> GetAllByUserId(int userId)
        {
            using (SqlConnection con = new SqlConnection(_connectionString))
            {
                return con.Query<Event>(
                    @"select e.EventId,
                             e.UserId,
                             e.EventName,
                             e.Descriptions,
                             e.Dates
                      from dbo.vEvent e
                      where e.UserId = @UserId;",
                    new { UserId = userId });
            }
        }
<<<<<<< HEAD
        /// <summary>
        /// Get Event by the EventName
        /// </summary>
        /// <param name="eventName"></param>
        /// <returns></returns>
=======

        public void Update(string eventName, string descriptions, DateTime dates, int userId)
        {
            using (SqlConnection con = new SqlConnection(_connectionString))
            {
                con.Execute(
                    "dbo.sEventUpdate",
                    new
                    {
                        EventName = eventName,
                        Descriptions = descriptions,
                        Dates = dates,
                        UserId = userId
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        public Event FindByEventId(int eventId)
        {
            using (SqlConnection con = new SqlConnection(_connectionString))
            {
                return con.Query<Event>(
                          @"select e.UserId,
                             e.EventName,
                             e.Descriptions,
                             e.Dates
                      from dbo.vEvent e
                      where e.EventId = @EventId;",
                        new { EventId = eventId })
                    .FirstOrDefault();
            }
        }


>>>>>>> EventsCreation
        public Event FindByName(string eventName)
        {
            using (SqlConnection con = new SqlConnection(_connectionString))
            {
                return con.Query<Event>(
                          @"select e.UserId,
                                   e.EventName,
                                   e.Descriptions,
                                   e.Dates
                            from dbo.vEvent e
                            where e.EventName = @EventName;",
                        new { EventName = eventName })
                    .FirstOrDefault();
            }
        }
    }
}
